C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE BOARD
OBJECT MODULE PLACED IN .\Output\Board.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Code\BSP\Board.c OPTIMIZE(4,SPEED) BROWSE INCDIR(.\Code\Common;.\Code;.\
                    -Code\BSP;.\Code\N76E003_HW) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\Board.lst) TABS(2) OBJECT(.\Output\Board.
                    -obj)

line level    source

   1          #include "Common.h"
   2          //#include "stdlib.h"
   3          #include "Timer.h"
   4          #include "GPIO.h"
   5          #include "UART.h"
   6          #include "PWM.h"
   7          #include "Audio.h"
   8          #include "Board.h"
   9          #include "LED.h"
  10          #include "ADC.h"
  11          /*
  12          **********************************************************************
  13          * 硬件抽象层
  14          * 
  15          * 
  16          * 
  17          *
  18          ***********************************************************************
  19          */
  20          
  21          /***********************Local function Define***********************/
  22           
  23          static void Timer3_IntHandler(void);
  24           
  25          /***********************Global Variables Define***********************/
  26          EUINT16 mTimerCnt[MAX_TIMER_NUM];
  27           
  28          EUINT8 mTock;
  29          EUINT8 mTIFlg;
  30          EUINT8 mlstock;
  31          EUINT8 mTick_1ms;
  32          EUINT16 mTick_1s;
  33           
  34           
  35          /*
  36          板级的初始化
  37          */
  38          void BoardInit(void)
  39          {
  40   1        WDT_Init();
  41   1        
  42   1        GPIO_Init();
  43   1        LED_Init();
  44   1        //Init_ADC();
  45   1      
  46   1        Timer3Init(Timer3_IntHandler);//1ms interrupt
  47   1      
  48   1        InitialUART0_Timer1(4800);
  49   1        PWM_Init();
  50   1        
  51   1        GlobalInterruptEnable();//使能中断全局GIE。
  52   1        StartTimer3();
  53   1      }
C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 2   

  54           
  55          ///*********************************************************************
  56          //Brief: MT_SetFoot_Left ,control the left foot motor 
  57          //Return: void
  58          //Called: 
  59          // 
  60          //**********************************************************************/
  61          //void MT_SetFoot_Left(UINT8 dir,UINT8 spd)
  62          //{
  63          
  64          //  if(spd==0)
  65          //  {//stop
  66          //    
  67          //  }
  68          //}
  69           
  70          
  71           
  72          /*********************************************************************
  73          Brief: SysShutdown ,进入低功耗状态
  74          Return: void
  75          Called: mainapp.c
  76           
  77          **********************************************************************/
  78          void SysShutdown(void)
  79          {
  80   1      
  81   1      }
  82          
  83          /*********************************************************************
  84          Brief: printstr ,测试打印
  85          Return: void
  86          Called: mainapp.c
  87           
  88          **********************************************************************/
  89          void printstr(UINT8* pdin,UINT8 dlen)
  90          {
  91   1        UART0SendData(pdin,dlen);
  92   1      }
  93          
  94           
  95          /*********************************************************************
  96          Brief: HW_Board_Poll ,硬件轮询函数入口
  97          Return: void
  98          Called: mainapp.c
  99           
 100          **********************************************************************/
 101          void HW_Board_Poll(void)
 102          {
 103   1       
 104   1      //////////////////////////Timer/////////////////////////////////    
 105   1        if(mTIFlg)
 106   1        {
 107   2          mTIFlg=0;
 108   2        }
 109   1        
 110   1        //1ms flag
 111   1        if(mTock==1 && mlstock==0)
 112   1        {
 113   2          mTick_1ms=1;
 114   2          mTick_1s++;
 115   2       
C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 3   

 116   2        }
 117   1        
 118   1        mlstock=mTock;
 119   1      }
 120          
 121           
 122          /*********************************************************************
 123          Brief: GetIRTick ,IR 计数器 , 750us记一次
 124          Return: void
 125          Called: mainapp.c
 126           
 127          **********************************************************************/
 128          UINT16 GetIRTick(void)
 129          {
 130   1        return GetTimer0Cnt();
 131   1      }
 132          
 133           
 134          
 135          /*********************************************************************
 136          Brief: GetTick_1s ,每秒输出1个脉冲
 137          Return: void
 138          Called: unkown
 139           
 140          **********************************************************************/
 141          UINT8 GetTick_1s(void)
 142          {
 143   1        if(mTick_1s>=1000) 
 144   1        {
 145   2          mTick_1s=0;
 146   2          return 1;
 147   2        }
 148   1        else
 149   1        {
 150   2          return 0;
 151   2        }
 152   1      }
 153          
 154           
 155          /*********************************************************************
 156          Brief: GetTick_1ms ,每毫秒输出1个脉冲
 157          Return: void
 158          Called: unkown
 159           
 160          **********************************************************************/
 161          UINT8 GetTick_1ms(void)
 162          {
 163   1        UINT8 ret;
 164   1        
 165   1        ret=mTick_1ms;
 166   1        mTick_1ms=0;
 167   1        return ret;
 168   1      }
 169          
 170           
 171          /*********************************************************************
 172          Brief: GetTickCount ,得到计数器的tick 用于产生伪随机数等场景
 173          Return: void
 174          Called: unkown
 175           
 176          **********************************************************************/
 177          UINT16 GetTickCount(void)
C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 4   

 178          {
 179   1        return GetTimer3Count();
 180   1      }
 181          
 182           
 183          /*********************************************************************
 184          Brief: SetTimer ,设置定时器  设定对应 id 定时器的周期
 185          Return: void
 186          Called: unkown
 187           
 188          **********************************************************************/
 189          UINT8 SetTimer(UINT8 id,UINT16 ms)
 190          {
 191   1        if(id>=MAX_TIMER_NUM) return 0xFF;
 192   1        
 193   1        mTimerCnt[id]=ms;
 194   1        
 195   1        return id;
 196   1      }
 197           
 198          /*********************************************************************
 199          Brief: GetTimer 查询定时器的计数状态
 200          return: 0 ,停止; 否则当前的计数值
 201          Called: unkown
 202           
 203          **********************************************************************/
 204          UINT16 GetTimer(UINT8 id)
 205          {
 206   1        return mTimerCnt[id];
 207   1      }
 208           
 209           
 210          /*********************************************************************
 211          Brief: GetIOLevel IR 4个接收引脚电平
 212          return: 0 ,停止; 否则当前的计数值
 213          Called: IRComm.c
 214           
 215          **********************************************************************/
 216          UINT8 GetIOLevel(UINT8 i)
 217          {
 218   1        UINT8 ret;
 219   1        
 220   1        switch(i)
 221   1        {
 222   2          case 0://front
 223   2            ret=GetPort1Val(7);
 224   2          break;
 225   2          case 1://back
 226   2            ret=GetPort3Val(0);
 227   2          break;
 228   2          case 2://left
 229   2            ret=GetPort0Val(5);
 230   2          break;
 231   2          case 3://right
 232   2            ret=GetPort0Val(7);
 233   2          break;
 234   2        }
 235   1        
 236   1        return ret;
 237   1      }
 238           
 239          /*********************************************************************
C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 5   

 240          Brief: SetAttackPin IR   IR 攻击输出 ,有问题,需要改
 241          return: 
 242          Called: IRComm.c
 243           
 244          **********************************************************************/
 245          void  SetAttackPin(UINT8 val)
 246          {
 247   1        SetPort2Val(0,val); //
 248   1      } 
 249          ////////////////////////////////////Interrupt handler////////////////////////////////////
 250          
 251          void RegGPIOIntHandler(UINT8 flg,FN_INT_HANDLER fn)
 252          {
 253   1        switch(flg)
 254   1        {
 255   2          case EXTI_INT0:
 256   2            SetEX0IntHandler(fn);
 257   2          break;
 258   2          case EXTI_INT1:
 259   2            SetEX1IntHandler(fn);
 260   2          break;
 261   2          case EXTI_Px5:
 262   2            SetGPx5IntHandler(fn);
 263   2          break;
 264   2          case EXTI_Px6:
 265   2            SetGPx6IntHandler(fn);
 266   2          break;
 267   2        
 268   2        }
 269   1      
 270   1      }
 271          
 272          u8 sysClockFlag = 0;
 273          void SetSysClock(void)
 274          {
 275   1        sysClockFlag = 1;
 276   1      }
 277          void ResetSysClock(void)
 278          {
 279   1        sysClockFlag = 0;
 280   1      }
 281          u8 GetSysClock(void)
 282          {
 283   1        return sysClockFlag;
 284   1      }
 285          
 286          /*
 287          timer3 interrupt handler   1mS interrpt
 288          */
 289          static void Timer3_IntHandler(void)
 290          {
 291   1        static u8 i=0;
 292   1        
 293   1        if(i<10)
 294   1        {
 295   2          i++;
 296   2        }
 297   1        else
 298   1        {
 299   2          i = 0;
 300   2          
 301   2          SetSysClock();
C51 COMPILER V9.52.0.0   BOARD                                                             11/14/2017 16:54:14 PAGE 6   

 302   2          
 303   2          //超时复位接收Buf
 304   2          if(CheckTimeOut())
 305   2          {
 306   3            ResetIndexRx();
 307   3            //MyPrintf("Reset Index\r\n");
 308   3          }   
 309   2        }
 310   1        
 311   1      
 312   1        //修改：让电流阈值随电池电压的降低而降低
 313   1        //if(Get_ADC() > 200)
 314   1        if(Get_ADC() > 180)
 315   1        {
 316   2          SetPWM_Stop();
 317   2          //SetPWM_Start();
 318   2        }
 319   1        else
 320   1        {
 321   2          SetPWM_Start();
 322   2        }
 323   1        
 324   1      }
 325          
 326          
 327           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    369    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     16    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
