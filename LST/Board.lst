C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE BOARD
OBJECT MODULE PLACED IN .\Output\Board.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Code\BSP\Board.c OPTIMIZE(4,SPEED) BROWSE INCDIR(.\Code\Common;.\Code;.\
                    -Code\BSP;.\Code\N76E003_HW) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\Board.lst) TABS(2) OBJECT(.\Output\Board.
                    -obj)

line level    source

   1          #include "Common.h"
   2          //#include "stdlib.h"
   3          #include "Timer.h"
   4          #include "GPIO.h"
   5          #include "UART.h"
   6          #include "PWM.h"
   7          #include "Audio.h"
   8          #include "Board.h"
   9          #include "LED.h"
  10          
  11          /*
  12          **********************************************************************
  13          * 硬件抽象层
  14          * 
  15          * 
  16          * 
  17          *
  18          ***********************************************************************
  19          */
  20          
  21          /***********************Local function Define***********************/
  22           
  23          static void Timer3_IntHandler(void);
  24           
  25          /***********************Global Variables Define***********************/
  26          EUINT16 mTimerCnt[MAX_TIMER_NUM];
  27           
  28          EUINT8 mTock;
  29          EUINT8 mTIFlg;
  30          EUINT8 mlstock;
  31          EUINT8 mTick_1ms;
  32          EUINT16 mTick_1s;
  33           
  34           
  35          /*
  36          板级的初始化
  37          */
  38          void BoardInit(void)
  39          {
  40   1        GPIO_Init();
  41   1        LED_Init();
  42   1        
  43   1        Timer3Init(Timer3_IntHandler);//1ms interrupt
  44   1        
  45   1        InitialUART0_Timer1(4800);
  46   1        PWM_Init();
  47   1        
  48   1        GlobalInterruptEnable();//使能中断全局GIE。
  49   1        StartTimer3();
  50   1      }
  51           
  52          ///*********************************************************************
  53          //Brief: MT_SetFoot_Left ,control the left foot motor 
C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 2   

  54          //Return: void
  55          //Called: 
  56          // 
  57          //**********************************************************************/
  58          //void MT_SetFoot_Left(UINT8 dir,UINT8 spd)
  59          //{
  60          
  61          //  if(spd==0)
  62          //  {//stop
  63          //    
  64          //  }
  65          //}
  66           
  67          
  68           
  69          /*********************************************************************
  70          Brief: SysShutdown ,进入低功耗状态
  71          Return: void
  72          Called: mainapp.c
  73           
  74          **********************************************************************/
  75          void SysShutdown(void)
  76          {
  77   1      
  78   1      }
  79          
  80          /*********************************************************************
  81          Brief: printstr ,测试打印
  82          Return: void
  83          Called: mainapp.c
  84           
  85          **********************************************************************/
  86          void printstr(UINT8* pdin,UINT8 dlen)
  87          {
  88   1        UART0SendData(pdin,dlen);
  89   1      }
  90          
  91           
  92          /*********************************************************************
  93          Brief: HW_Board_Poll ,硬件轮询函数入口
  94          Return: void
  95          Called: mainapp.c
  96           
  97          **********************************************************************/
  98          void HW_Board_Poll(void)
  99          {
 100   1       
 101   1      //////////////////////////Timer/////////////////////////////////    
 102   1        if(mTIFlg)
 103   1        {
 104   2          mTIFlg=0;
 105   2        }
 106   1        
 107   1        //1ms flag
 108   1        if(mTock==1 && mlstock==0)
 109   1        {
 110   2          mTick_1ms=1;
 111   2          mTick_1s++;
 112   2       
 113   2        }
 114   1        
 115   1        mlstock=mTock;
C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 3   

 116   1      }
 117          
 118           
 119          /*********************************************************************
 120          Brief: GetIRTick ,IR 计数器 , 750us记一次
 121          Return: void
 122          Called: mainapp.c
 123           
 124          **********************************************************************/
 125          UINT16 GetIRTick(void)
 126          {
 127   1        return GetTimer0Cnt();
 128   1      }
 129          
 130           
 131          
 132          /*********************************************************************
 133          Brief: GetTick_1s ,每秒输出1个脉冲
 134          Return: void
 135          Called: unkown
 136           
 137          **********************************************************************/
 138          UINT8 GetTick_1s(void)
 139          {
 140   1        if(mTick_1s>=1000) 
 141   1        {
 142   2          mTick_1s=0;
 143   2          return 1;
 144   2        }
 145   1        else
 146   1        {
 147   2          return 0;
 148   2        }
 149   1      }
 150          
 151           
 152          /*********************************************************************
 153          Brief: GetTick_1ms ,每毫秒输出1个脉冲
 154          Return: void
 155          Called: unkown
 156           
 157          **********************************************************************/
 158          UINT8 GetTick_1ms(void)
 159          {
 160   1        UINT8 ret;
 161   1        
 162   1        ret=mTick_1ms;
 163   1        mTick_1ms=0;
 164   1        return ret;
 165   1      }
 166          
 167           
 168          /*********************************************************************
 169          Brief: GetTickCount ,得到计数器的tick 用于产生伪随机数等场景
 170          Return: void
 171          Called: unkown
 172           
 173          **********************************************************************/
 174          UINT16 GetTickCount(void)
 175          {
 176   1        return GetTimer3Count();
 177   1      }
C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 4   

 178          
 179           
 180          /*********************************************************************
 181          Brief: SetTimer ,设置定时器  设定对应 id 定时器的周期
 182          Return: void
 183          Called: unkown
 184           
 185          **********************************************************************/
 186          UINT8 SetTimer(UINT8 id,UINT16 ms)
 187          {
 188   1        if(id>=MAX_TIMER_NUM) return 0xFF;
 189   1        
 190   1        mTimerCnt[id]=ms;
 191   1        
 192   1        return id;
 193   1      }
 194           
 195          /*********************************************************************
 196          Brief: GetTimer 查询定时器的计数状态
 197          return: 0 ,停止; 否则当前的计数值
 198          Called: unkown
 199           
 200          **********************************************************************/
 201          UINT16 GetTimer(UINT8 id)
 202          {
 203   1        return mTimerCnt[id];
 204   1      }
 205           
 206           
 207          /*********************************************************************
 208          Brief: GetIOLevel IR 4个接收引脚电平
 209          return: 0 ,停止; 否则当前的计数值
 210          Called: IRComm.c
 211           
 212          **********************************************************************/
 213          UINT8 GetIOLevel(UINT8 i)
 214          {
 215   1        UINT8 ret;
 216   1        
 217   1        switch(i)
 218   1        {
 219   2          case 0://front
 220   2            ret=GetPort1Val(7);
 221   2          break;
 222   2          case 1://back
 223   2            ret=GetPort3Val(0);
 224   2          break;
 225   2          case 2://left
 226   2            ret=GetPort0Val(5);
 227   2          break;
 228   2          case 3://right
 229   2            ret=GetPort0Val(7);
 230   2          break;
 231   2        }
 232   1        
 233   1        return ret;
 234   1      }
 235           
 236          /*********************************************************************
 237          Brief: SetAttackPin IR   IR 攻击输出 ,有问题,需要改
 238          return: 
 239          Called: IRComm.c
C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 5   

 240           
 241          **********************************************************************/
 242          void  SetAttackPin(UINT8 val)
 243          {
 244   1        SetPort2Val(0,val); //
 245   1      } 
 246          ////////////////////////////////////Interrupt handler////////////////////////////////////
 247          
 248          void RegGPIOIntHandler(UINT8 flg,FN_INT_HANDLER fn)
 249          {
 250   1        switch(flg)
 251   1        {
 252   2          case EXTI_INT0:
 253   2            SetEX0IntHandler(fn);
 254   2          break;
 255   2          case EXTI_INT1:
 256   2            SetEX1IntHandler(fn);
 257   2          break;
 258   2          case EXTI_Px5:
 259   2            SetGPx5IntHandler(fn);
 260   2          break;
 261   2          case EXTI_Px6:
 262   2            SetGPx6IntHandler(fn);
 263   2          break;
 264   2        
 265   2        }
 266   1      
 267   1      }
 268          
 269          u8 sysClockFlag = 0;
 270          void SetSysClock(void)
 271          {
 272   1        sysClockFlag = 1;
 273   1      }
 274          void ResetSysClock(void)
 275          {
 276   1        sysClockFlag = 0;
 277   1      }
 278          u8 GetSysClock(void)
 279          {
 280   1        return sysClockFlag;
 281   1      }
 282          
 283          /*
 284          timer3 interrupt handler   1mS interrpt
 285          */
 286          static void Timer3_IntHandler(void)
 287          {
 288   1        SetSysClock();
 289   1        
 290   1        //超时复位接收Buf
 291   1        if(CheckTimeOut())
 292   1        {
 293   2          ResetIndexRx();
 294   2          //MyPrintf("Reset Index\r\n");
 295   2        }
 296   1        
 297   1      }
 298          
 299          
 300           

C51 COMPILER V9.52.0.0   BOARD                                                             09/15/2017 18:03:37 PAGE 6   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    328    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     15    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
